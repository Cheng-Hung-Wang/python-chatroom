<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
</head>
<body>
<script src="http://cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
<label>输入姓名</label>
<input id="name"/ max="5">
<br>
<input id="input"/>
<button id="post">发言</button>
<script>
$('#name').on('blur', function(){
    $.ajax({
        url: '/name',
        method: 'POST',
        data: $(this).val().trim(),
        success: function(resp) {
            alert(resp.toString());
        },
        error: function(xhr, err, exp) {
            alert('修改失败');
        }
    })
});

$('#post').click(function(){
    $.ajax('/post', {
        method: 'POST',
        timeout: 1000,
        data: $('#input').val()
    });
});

$(window).bind("beforeunload", function() {
    $.ajax('/exit', {
        method: 'POST',
    });
});

var last_message = '';
(function poll() {
    $.ajax('/poll', {
        method: 'POST',
        timeout: 1000*60*10, //10 minutes
        success: function(data){
            $("<p>"+data+"</p>").appendTo($(document.body));
            last_message = data;
            poll();
        },
        error: function(){
            setTimeout(poll, 1000);
        },
        data: last_message
    });
}());
</script>
</body>
</html>